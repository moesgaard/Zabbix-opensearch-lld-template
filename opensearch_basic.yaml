zabbix_export:
  version: "7.0"
  template_groups:
    - uuid: f43b9a15b7374df3ad367ead192d0c64
      name: "Opensearch"
  templates:
    - uuid: e806e9868bcd4945b20946139001cff1
      template: "Opensearch Basic Node Monitoring"
      name: "Opensearch Basic Node Monitoring"
      description: "This template is automatic added to Opensearch LLD discovered with the cluster manager role."
      groups:
        - name: "Opensearch"
      items:
        - uuid: 00e1f6c559c44a998344ccf246cde192
          name: "Opensearch Discover basic discovery"
          type: SCRIPT
          key: opensearch.discover.nodes.basic.stats
          history: "0"
          value_type: TEXT
          trends: "0"
          params: |
            parameters = JSON.parse(value);
            master= parameters['master'];
            port = parameters['port'];
            host = parameters['host']; 
            auth = btoa(parameters['username']+":"+parameters['password'])
            request = new HttpRequest();
            request.addHeader('Authorization: Basic '+auth);
            response = request.get("https://"+master+":"+port+"/_nodes/"+host+"/stats");  
            if(request.getStatus() == "200" ){
            	return response;
            }
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.nodes
            - type: JAVASCRIPT
              parameters:
                - |
                  data = JSON.parse(value);
                  newset = [];
                  // Get the first (and only) key in the data object
                  var mainKey = Object.keys(data)[0];
                  // Extract JVM and OS info
                  var jvmInfo = data[mainKey].jvm;
                  var osInfo = data[mainKey].os;
                  var fsInfo = data[mainKey].fs;
                  var tpInfo = data[mainKey].thread_pool;
                  newset.push({'os': osInfo });
                  newset.push({'jvm': jvmInfo });
                  newset.push({'fs': fsInfo });
                  newset.push({'thread_pool': tpInfo });
                  return JSON.stringify(newset);

            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "120"
          timeout: 30s
          parameters:
            - name: auth
              value: "{$OPENSEARCH.APIKEY}"
            - name: host
              value: "{$HOSTIP}"
            - name: master
              value: "{$OPENSEARCH.MASTER}"
            - name: password
              value: "{$OPENSEARCH.PASSWORD}"
            - name: port
              value: "9200"
            - name: username
              value: "{$OPENSEARCH.USERNAME}"
          tags:
            - tag: Type
              value: raw
        - uuid: 3e8bed79b2474c3dbd285ff8ba395886
          name: "Opensearch tasks"
          type: SCRIPT
          key: opensearch.discover.nodes.basic.tasks
          history: "0"
          value_type: TEXT
          trends: "0"
          params: |
            parameters = JSON.parse(value);
            master= parameters['master'];
            port = parameters['port'];
            host = parameters['host']; 
            auth = btoa(parameters['username']+":"+parameters['password'])
            request = new HttpRequest();
            request.addHeader('Authorization: Basic '+auth);
            response = request.get("https://"+master+":"+port+"/_tasks?nodes="+host+"");  
            if(request.getStatus() == "200" ){
            	return response;
            }
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "120"
          timeout: 30s
          parameters:
            - name: auth
              value: "{$OPENSEARCH.APIKEY}"
            - name: host
              value: "{$HOSTIP}"
            - name: master
              value: "{$OPENSEARCH.MASTER}"
            - name: password
              value: "{$OPENSEARCH.PASSWORD}"
            - name: port
              value: "9200"
            - name: username
              value: "{$OPENSEARCH.USERNAME}"
          tags:
            - tag: Type
              value: raw
        - uuid: 07e68dba618440f0abd24d561fe3c260
          name: "JVM Memory pools old used in bytes"
          type: DEPENDENT
          key: opensearch.host..jvm.mem.pools.old.used_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.mem.pools.old.used_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: c41b9f3a1698451e97adace9e7e9544f
          name: "JVM Memory pools survivor used in bytes"
          type: DEPENDENT
          key: opensearch.host..jvm.mem.pools.survivor.used_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.mem.pools.survivor.used_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: 1d79a433f7374c8d8317c72a7ebf8126
          name: "JVM Memory pools young used in bytes"
          type: DEPENDENT
          key: opensearch.host..jvm.mem.pools.young.used_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.mem.pools.young.used_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: 38e0d8e5831e4fb39bdcd79c44e33eaa
          name: "JVM System Uptime"
          type: DEPENDENT
          key: opensearch.host..jvm.uptime_in_millis
          delay: "0"
          units: s
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.uptime_in_millis
            - type: TRIM
              parameters:
                - "[]"
            - type: MULTIPLIER
              parameters:
                - "0.001"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: 4e2976cdc98949b4abbc8da7bb7408f3
          name: "FS IO stats read operrations"
          type: DEPENDENT
          key: opensearch.host.fs.io_stats.total.read_operations
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..fs.io_stats.total.read_operations
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: disk
            - tag: Resource
              value: Filesystem
        - uuid: 9bf747328b224e1b9bdabccb13a7a631
          name: "FS IO stats read  time in ms"
          type: DEPENDENT
          key: opensearch.host.fs.io_stats.total.read_time
          delay: "0"
          units: s
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..fs.io_stats.total.read_time
            - type: TRIM
              parameters:
                - "[]"
            - type: MULTIPLIER
              parameters:
                - "0.001"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: disk
            - tag: Resource
              value: Filesystem
        - uuid: f1d8017fbb9e42ae9a7b297bbabb78c9
          name: "FS IO stats write operrations"
          type: DEPENDENT
          key: opensearch.host.fs.io_stats.total.write_operations
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..fs.io_stats.total.write_operations
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: disk
            - tag: Resource
              value: Filesystem
        - uuid: 3271edfb963d409e9c0128bcc2bfcb0e
          name: "FS IO stat write time in ms"
          type: DEPENDENT
          key: opensearch.host.fs.io_stats.total.write_time
          delay: "0"
          units: s
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..fs.io_stats.total.write_time
            - type: TRIM
              parameters:
                - "[]"
            - type: MULTIPLIER
              parameters:
                - "0.001"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: disk
            - tag: Resource
              value: Filesystem
        - uuid: 6fed990b7bd644fd9981268e433d1982
          name: "FS total free in bytes"
          type: DEPENDENT
          key: opensearch.host.fs.total.free_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..fs.total.free_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: disk
            - tag: Resource
              value: Filesystem
        - uuid: cd23a07104694da1b4d835c26095cbed
          name: "JVM Memory Heap Max"
          type: DEPENDENT
          key: opensearch.host.jvm.mem.heap_max_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.mem.heap_max_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: 08561cd060e64a6b87deceb6dbab2806
          name: "JVM Memory Heap Used"
          type: DEPENDENT
          key: opensearch.host.jvm.mem.heap_used_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.mem.heap_used_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: system
            - tag: Resource
              value: JVM
        - uuid: af74134a4b4a456994407bc3d405446c
          name: "OS CPU Load avg 1 min"
          type: DEPENDENT
          key: opensearch.host.os.cpu.load_average.1m
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..os.cpu.load_average.1m
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: CPU
            - tag: Resource
              value: OS
        - uuid: 58019f35a10145fd972fd674af5005f5
          name: "OS CPU Load avg 5 min"
          type: DEPENDENT
          key: opensearch.host.os.cpu.load_average.5m
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..os.cpu.load_average.5m
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: CPU
            - tag: Resource
              value: OS
        - uuid: 3e4de290e1754e499dbe1505e45d4342
          name: "OS CPU Load avg 15 min"
          type: DEPENDENT
          key: opensearch.host.os.cpu.load_average.15m
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..os.cpu.load_average.15m
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: CPU
            - tag: Resource
              value: OS
        - uuid: acfedc3f55ac47a3b4e266a9bb159d5a
          name: "OS CPU percent used"
          type: DEPENDENT
          key: opensearch.host.os.cpu.persent
          delay: "0"
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..os.cpu.percent
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: CPU
            - tag: Resource
              value: OS
        - uuid: 9206043d867c4705895eb7618e31c898
          name: "OS Memory Used"
          type: DEPENDENT
          key: opensearch.host.os.mem.used_in_bytes
          delay: "0"
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..os.mem.used_in_bytes
            - type: TRIM
              parameters:
                - "[]"
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - "3600"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          tags:
            - tag: component
              value: Memory
            - tag: Resource
              value: OS
      discovery_rules:
        - uuid: 4fc2cbf911434f42918f5dd942f22dea
          name: "Thread pool low level discovery"
          type: DEPENDENT
          key: opensearch.lld.host.thread_pool
          delay: "0"
          filter:
            conditions:
              - macro: "{#NAME}"
                value: "{$OPENSEARCH.THREADPOOL.FILTER}"
                formulaid: A
          item_prototypes:
            - uuid: 075cc53f2e55479bbca4bab19b8d57a5
              name: "Thread {#NAME} active size"
              type: DEPENDENT
              key: "opensearch.host.thread_pool.active[{#NAME}]"
              delay: "0"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..thread_pool["{#NAME}"].active'
                - type: TRIM
                  parameters:
                    - "[]"
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - "3600"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: Thread
                - tag: Resource
                  value: "Thread Pool"
            - uuid: 8111416c90d4438bbf303741ac7065fb
              name: "Thread {#NAME} queue size"
              type: DEPENDENT
              key: "opensearch.host.thread_pool.queue[{#NAME}]"
              delay: "0"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..thread_pool["{#NAME}"].queue'
                - type: TRIM
                  parameters:
                    - "[]"
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - "3600"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: Thread
                - tag: Resource
                  value: "Thread Pool"
            - uuid: d662b03f19f54b63930ff4c074091e7a
              name: "Thread {#NAME} rejected size"
              type: DEPENDENT
              key: "opensearch.host.thread_pool.rejected[{#NAME}]"
              delay: "0"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..thread_pool["{#NAME}"].rejected'
                - type: TRIM
                  parameters:
                    - "[]"
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - "3600"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: Thread
                - tag: Resource
                  value: "Thread Pool"
            - uuid: f67a7ba4312c4c6da3820c96af6454c5
              name: "Thread {#NAME} threads size"
              type: DEPENDENT
              key: "opensearch.host.thread_pool.threads[{#NAME}]"
              delay: "0"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..thread_pool["{#NAME}"].threads'
                - type: TRIM
                  parameters:
                    - "[]"
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - "3600"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: Thread
                - tag: Resource
                  value: "Thread Pool"
          graph_prototypes:
            - uuid: 1a95742034324aa598890a0e6cbbacfe
              name: "{#CLUSTERNAME} : Thread {#NAME}"
              graph_items:
                - color: 199C0D
                  calc_fnc: ALL
                  item:
                    host: "Opensearch Basic Node Monitoring"
                    key: "opensearch.host.thread_pool.active[{#NAME}]"
                - sortorder: "1"
                  color: F63100
                  calc_fnc: ALL
                  item:
                    host: "Opensearch Basic Node Monitoring"
                    key: "opensearch.host.thread_pool.queue[{#NAME}]"
                - sortorder: "2"
                  color: 2774A4
                  calc_fnc: ALL
                  item:
                    host: "Opensearch Basic Node Monitoring"
                    key: "opensearch.host.thread_pool.rejected[{#NAME}]"
                - sortorder: "3"
                  color: F7941D
                  calc_fnc: ALL
                  item:
                    host: "Opensearch Basic Node Monitoring"
                    key: "opensearch.host.thread_pool.threads[{#NAME}]"
          master_item:
            key: opensearch.discover.nodes.basic.stats
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..thread_pool
            - type: JAVASCRIPT
              parameters:
                - |
                  data = JSON.parse(value);
                  keys = Object.keys(data[0]);
                  b_ob = [];
                  for(i = 0; i < keys.length; i++ ){
                    b_ob.push({"{#NAME}": keys[i],"{#CLUSTERNAME}": "{$CLUSTERNAME}"});
                  }

                  return '{ "data" : '+JSON.stringify(b_ob)+'}';
        - uuid: 4089547f5be541bbbc808e8e78c1bd10
          name: "Garbage Collector"
          type: DEPENDENT
          key: opensearch.lld.jvm.gc.collector
          delay: "0"
          enabled_lifetime_type: DISABLE_AFTER
          enabled_lifetime: 1h
          item_prototypes:
            - uuid: 9b0fc159d2024165ad3afea20c5b9d48
              name: "Garbage Collector {#NAME} collection count"
              type: DEPENDENT
              key: "opensearch.lld.host.jvm.gc.collectors.collection_count[{#NAME}]"
              delay: "0"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..jvm.gc.collectors.["{#NAME}"].collection_count'
                - type: TRIM
                  parameters:
                    - "[]"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: collector
            - uuid: 1d15b8d98ea248f782ed3fffe1794852
              name: "Garbage Collector {#NAME} collection time in milliseconds"
              type: DEPENDENT
              key: "opensearch.lld.host.jvm.gc.collectors.collection_time_in_millis[{#NAME}]"
              delay: "0"
              units: ms
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$..jvm.gc.collectors.["{#NAME}"].collection_time_in_millis'
                - type: TRIM
                  parameters:
                    - "[]"
              master_item:
                key: opensearch.discover.nodes.basic.stats
              tags:
                - tag: component
                  value: collector
          master_item:
            key: opensearch.discover.nodes.basic.stats
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..jvm.gc.collectors
            - type: JAVASCRIPT
              parameters:
                - |
                  data = JSON.parse(value);
                  keys = Object.keys(data[0]);
                  b_ob = [];
                  for(i = 0; i < keys.length; i++ ){
                    b_ob.push({"{#NAME}": keys[i]});
                  }

                  return '{ "data" : '+JSON.stringify(b_ob)+'}';
      macros:
        - macro: "{$CLUSTERNAME}"
